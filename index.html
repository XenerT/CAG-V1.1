<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CAG Dental v19.5 (Ultimate iOS)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <style>
        :root {
            --primary: #f59e0b; /* Talha Turuncusu */
            --bg-body: #f2f2f7;
            --bg-card: #ffffff;
            --text-main: #000000;
            --text-muted: #8e8e93;
            --border: #d1d1d6;
            --danger: #ff3b30;
            --success: #34c759;
            /* iPhone Çentik ve Alt Çizgi Değişkenleri */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body.dark-mode {
            --primary: #fbbf24;
            --bg-body: #000000;
            --bg-card: #1c1c1e;
            --text-main: #ffffff;
            --text-muted: #98989d;
            --border: #38383a;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); color: var(--text-main); 
            height: 100vh; width: 100vw;
            overflow: hidden; 
            display: flex; flex-direction: column;
        }

        /* --- HEADER (SAFE AREA FIX) --- */
        .ios-header {
            flex-shrink: 0;
            /* Üstten Çentik Kadar + 15px Boşluk */
            padding-top: calc(var(--safe-top) + 15px); 
            padding-bottom: 10px;
            padding-left: 20px; padding-right: 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            font-weight: 700; font-size: 22px;
            z-index: 50;
            height: auto; /* Otomatik yükseklik */
            min-height: 80px; /* Minimum yükseklik */
        }

        /* --- MAIN CONTENT (SCROLL & PADDING FIX) --- */
        .main-content {
            flex: 1;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            /* Sağdan Soldan 10px, Alttan 120px Boşluk */
            padding: 15px 10px 120px 10px; 
            position: relative;
        }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- CARDS & LISTS --- */
        .ios-card { 
            background: var(--bg-card); 
            border-radius: 16px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.04); 
        }

        .patient-item { 
            padding: 15px 0; 
            border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center;
        }
        .patient-item:last-child { border-bottom: none; }
        
        /* --- BOTTOM NAV (GERİ GELDİ) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: calc(60px + var(--safe-bottom));
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding-bottom: var(--safe-bottom);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .nav-btn {
            background: none; border: none;
            display: flex; flex-direction: column; align-items: center;
            font-size: 10px; color: var(--text-muted); gap: 4px;
            width: 100%;
        }
        .nav-btn.active { color: var(--primary); font-weight: 600; }
        .nav-btn i { font-size: 24px; margin-bottom: 2px; }

        /* --- FAB --- */
        .fab {
            position: fixed; bottom: calc(80px + var(--safe-bottom)); right: 20px;
            width: 56px; height: 56px;
            background: var(--primary); color: white;
            border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; border: none; z-index: 90;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000;
            display: none; align-items: flex-end;
        }
        .modal-card {
            background: var(--bg-card);
            width: 100%; height: 90vh; 
            border-radius: 20px 20px 0 0;
            display: flex; flex-direction: column;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); border-radius: 20px 20px 0 0;
        }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 50px; }

        /* Form Elemanları */
        .form-input { 
            width: 100%; padding: 14px; margin-bottom: 15px; 
            background: var(--bg-body); border: none; 
            border-radius: 10px; font-size: 16px; color: var(--text-main);
        }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }

        /* FullCalendar Custom (Mobile Friendly) */
        .fc { font-family: 'Inter', sans-serif; height: 100%; }
        .fc-toolbar-title { font-size: 16px !important; font-weight: 700; }
        .fc-button { padding: 6px 10px !important; font-size: 12px !important; }
        .fc-header-toolbar { margin-bottom: 10px !important; }
        /* Saat aralıklarını genişlet (Rahat tıklama için) */
        .fc-timegrid-slot { height: 60px !important; } 

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg-body);z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div class="ios-card" style="width:300px; text-align:center;">
            <i class="ph-fill ph-tooth" style="font-size:48px; color:var(--primary); margin-bottom:20px;"></i>
            <h2 style="margin-bottom:30px;">CAG Dental</h2>
            <form onsubmit="event.preventDefault(); login()">
                <input type="text" id="user" class="form-input" placeholder="Kullanıcı Adı">
                <input type="password" id="pass" class="form-input" placeholder="Şifre">
                <button class="btn btn-primary">Giriş Yap</button>
            </form>
        </div>
    </div>

    <div id="app-layout" class="hidden">
        <header class="ios-header">
            <span id="page-title">Takvim</span>
            <span id="dr-avatar" style="background:var(--primary); color:white; width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:50%; font-size:14px;">TK</span>
        </header>

        <main class="main-content">
            <div id="view-dashboard" class="view-section active">
                <div class="ios-card" style="height: 100vh; padding:0; overflow:hidden;">
                    <div id="calendar" style="height:100%;"></div>
                </div>
            </div>

            <div id="view-patients" class="view-section">
                <input type="text" class="form-input" placeholder="Hasta Ara (Ad, TC)..." oninput="filterPatients(this.value)">
                <div class="ios-card" id="patient-list-container">
                    </div>
            </div>

            <div id="view-finance" class="view-section">
                <div class="ios-card" style="text-align:center; padding:40px 20px;">
                    <span style="font-size:14px; color:var(--text-muted);">Toplam Ciro</span>
                    <h1 id="fin-total" style="color:var(--success); font-size:36px; margin:15px 0;">**** ₺</h1>
                    <button class="btn btn-secondary" onclick="toggleRevenue()">Göster / Gizle</button>
                </div>
            </div>

            <div id="view-more" class="view-section">
                <div class="ios-card">
                    <button class="btn btn-secondary" onclick="toggleDarkMode()">
                        <i class="ph-fill ph-moon"></i> Tema Değiştir
                    </button>
                    <button class="btn btn-danger" onclick="logoutLogic()">Çıkış Yap</button>
                </div>
                <div class="ios-card">
                    <h3>Gelmeyenler</h3>
                    <div id="missed-list-container"></div>
                </div>
            </div>
        </main>

        <button class="fab" onclick="openAddModal()"><i class="ph-bold ph-plus"></i></button>

        <nav class="bottom-nav">
            <button class="nav-btn active" onclick="switchView('dashboard', this)">
                <i class="ph-fill ph-calendar-blank"></i> Takvim
            </button>
            <button class="nav-btn" onclick="switchView('patients', this)">
                <i class="ph-fill ph-users"></i> Hastalar
            </button>
            <button class="nav-btn" onclick="switchView('finance', this)">
                <i class="ph-fill ph-currency-lira"></i> Finans
            </button>
            <button class="nav-btn" onclick="switchView('more', this)">
                <i class="ph-fill ph-dots-three-circle"></i> Diğer
            </button>
        </nav>
    </div>

    <div id="patient-modal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3>İşlem Yap</h3>
                <div onclick="closeModal('patient-modal')" style="background:var(--bg-body); width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                    <i class="ph-bold ph-x"></i>
                </div>
            </div>
            <div class="modal-body">
                <form id="patient-form" onsubmit="event.preventDefault(); savePatient()">
                    <input type="hidden" id="p-id">
                    
                    <label style="font-size:12px; color:var(--text-muted);">TC Kimlik</label>
                    <input type="tel" id="p-tc" class="form-input" maxlength="11" oninput="searchPatientByTC(this.value)">
                    
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="p-name" class="form-input" placeholder="Ad" required>
                        <input type="text" id="p-surname" class="form-input" placeholder="Soyad" required>
                    </div>

                    <label style="font-size:12px; color:var(--text-muted);">Tarih & Saat</label>
                    <div style="display:flex; gap:10px;">
                        <input type="date" id="p-date" class="form-input" required>
                        <input type="time" id="p-time" class="form-input" required onchange="autoSetEndTime()">
                        <input type="time" id="p-end-time" class="form-input">
                    </div>

                    <label style="font-size:12px; color:var(--text-muted);">Hekim</label>
                    <select id="p-doctor" class="form-input">
                        <option>Talha Kuş</option>
                        <option>Kadir Doğan</option>
                    </select>

                    <label style="font-size:12px; color:var(--text-muted);">Durum</label>
                    <select id="p-status" class="form-input" onchange="toggleFin(this.value)">
                        <option value="bekliyor">Bekliyor</option>
                        <option value="bitti">Bitti</option>
                        <option value="iptal">İptal</option>
                    </select>

                    <div id="fin-box" class="hidden">
                        <label style="font-size:12px; color:var(--text-muted);">Tutar (TL)</label>
                        <input type="number" id="p-price" class="form-input">
                    </div>

                    <label style="font-size:12px; color:var(--text-muted);">Notlar</label>
                    <textarea id="p-notes" class="form-input"></textarea>

                    <button class="btn btn-primary">KAYDET</button>
                    <button type="button" class="btn btn-danger hidden" id="btn-delete" onclick="deleteCurrentP()">SİL</button>
                    <div style="height:20px;"></div> </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIkIwrB3UgCCTucYR-EOS2MG8SLEiy_LA",
            authDomain: "cag-dental-3585.firebaseapp.com",
            projectId: "cag-dental-3585",
            storageBucket: "cag-dental-3585.firebasestorage.app",
            messagingSenderId: "1039279310840",
            appId: "1:1039279310840:web:0744002fa795632750380d",
            measurementId: "G-XLBMJZDZBZ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const users = {"Talha":"3585", "Kadir":"3585"};
        const doctorColors = { "Talha Kuş": "#f59e0b", "Kadir Doğan": "#3b82f6" };

        let patients = [];
        let currentDoctor = "Talha Kuş";
        let calendar;

        // HELPER FUNCTIONS
        function minutesFromTime(t) { if(!t) return 0; const [h,m]=t.split(':').map(Number); return h*60+m; }
        function timeFromMinutes(m) { const h=Math.floor(m/60); const mn=m%60; return `${String(h).padStart(2,'0')}:${String(mn).padStart(2,'0')}`; }

        window.login = function() {
            const u = document.getElementById("user").value;
            const p = document.getElementById("pass").value;
            if(users[u] && users[u]===p) {
                currentDoctor = u === "Talha" ? "Talha Kuş" : "Kadir Doğan";
                document.getElementById("dr-avatar").innerText = u === "Talha" ? "TK" : "KD";
                document.getElementById("login-screen").classList.add("hidden");
                document.getElementById("app-layout").classList.remove("hidden");
                startRealtimeListener();
                initFullCalendar();
            } else { alert("Hatalı Giriş!"); }
        }

        window.switchView = function(id, btn) {
            document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            btn.classList.add('active');
            
            document.getElementById("page-title").innerText = btn.innerText.trim();

            if(id === 'patients') renderPatientList();
            if(id === 'dashboard' && calendar) setTimeout(() => calendar.render(), 100);
        }

        window.logoutLogic = function() { location.reload(); }
        window.toggleDarkMode = function() { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); }
        if(localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark-mode');

        window.toggleRevenue = function() {
            const el = document.getElementById("fin-total");
            if(el.innerText.includes("*")) {
                const total = patients.reduce((a,b) => a + (b.price || 0), 0);
                el.innerText = total + " ₺";
            } else {
                el.innerText = "**** ₺";
            }
        }

        window.autoSetEndTime = function() {
            const t = document.getElementById("p-time").value;
            if(t) document.getElementById("p-end-time").value = timeFromMinutes(minutesFromTime(t) + 30);
        }

        // FIREBASE
        function startRealtimeListener() {
            const q = query(collection(db, "patients"));
            onSnapshot(q, (snapshot) => {
                patients = [];
                snapshot.forEach((doc) => { let d = doc.data(); d.id = doc.id; patients.push(d); });
                
                if(calendar) updateCalendarEvents();
                if(document.getElementById('view-patients').classList.contains('active')) renderPatientList();
                renderMissedList();
            });
        }

        // FULLCALENDAR (MOBILE TAP FIX)
        function initFullCalendar() {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridDay',
                locale: 'tr',
                headerToolbar: { left: 'prev,next', center: 'title', right: 'timeGridDay,dayGridMonth' },
                slotMinTime: '08:00:00',
                slotMaxTime: '22:00:00',
                allDaySlot: false,
                slotDuration: '00:15:00',
                height: '100%',
                nowIndicator: true,
                selectable: true,
                editable: true,
                longPressDelay: 0, // DOKUNUR DOKUNMAZ TEPKİ VER (Tap Fix)
                selectLongPressDelay: 0, // SEÇİM İÇİN DE GECİKME YOK

                eventClick: function(info) { openEdit(info.event.id); },
                
                // BOŞ ALANA TIKLAMA
                select: function(info) {
                    const dateStr = info.startStr.split('T')[0];
                    const timeStr = info.startStr.split('T')[1].substring(0,5);
                    openAddModal(dateStr, timeStr);
                },
                dateClick: function(info) {
                    // Ekstra güvenlik: dateClick de modal açsın
                    if(info.view.type.includes('timeGrid')) {
                         const dateStr = info.dateStr.split('T')[0];
                         const timeStr = info.dateStr.split('T')[1].substring(0,5);
                         openAddModal(dateStr, timeStr);
                    }
                },

                eventDrop: async function(info) {
                    const newDate = info.event.start.toISOString().split('T')[0];
                    const newTime = info.event.start.toTimeString().split(' ')[0].substring(0,5);
                    let newEndTime = null;
                    if(info.event.end) newEndTime = info.event.end.toTimeString().split(' ')[0].substring(0,5);
                    else newEndTime = timeFromMinutes(minutesFromTime(newTime) + 30);
                    await updateDoc(doc(db, "patients", info.event.id), { date: newDate, time: newTime, endTime: newEndTime });
                },
                eventResize: async function(info) {
                    const newEndTime = info.event.end.toTimeString().split(' ')[0].substring(0,5);
                    await updateDoc(doc(db, "patients", info.event.id), { endTime: newEndTime });
                }
            });
            calendar.render();
        }

        function updateCalendarEvents() {
            if(!calendar) return;
            const events = patients.filter(p => p.status !== 'gelmedi').map(p => ({
                id: p.id,
                title: `${p.name} ${p.surname}`,
                start: `${p.date}T${p.time}:00`,
                end: p.endTime ? `${p.date}T${p.endTime}:00` : null,
                backgroundColor: doctorColors[p.doctor] || '#f59e0b',
                borderColor: 'transparent'
            }));
            calendar.removeAllEvents();
            calendar.addEventSource(events);
        }

        // LISTS
        window.renderPatientList = function() {
            const container = document.getElementById("patient-list-container");
            const filter = document.querySelector("#view-patients input").value.toLowerCase();
            let html = "";
            const filtered = patients.filter(p => (p.name + " " + p.surname + " " + p.tc).toLowerCase().includes(filter));
            
            if(filtered.length === 0) { container.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>Kayıt yok.</div>"; return; }

            filtered.forEach(p => {
                let color = p.status === 'bitti' ? 'var(--success)' : (p.status === 'iptal' ? 'var(--danger)' : 'var(--primary)');
                html += `
                <div class="patient-item" onclick="openEdit('${p.id}')">
                    <div class="p-info">
                        <span class="p-name">${p.name} ${p.surname}</span>
                        <span class="p-detail">${p.date} | ${p.time}</span>
                    </div>
                    <span style="background:${color}; color:white; padding:3px 8px; border-radius:6px; font-size:11px;">${p.status}</span>
                </div>`;
            });
            container.innerHTML = html;
        }
        window.filterPatients = function() { renderPatientList(); }

        window.renderMissedList = function() {
            const container = document.getElementById("missed-list-container");
            const missed = patients.filter(p => p.status === 'gelmedi');
            container.innerHTML = missed.length ? missed.map(p => `
                <div class="patient-item">
                    <span>${p.name} ${p.surname} <br> <small style="color:red">${p.date}</small></span>
                    <button class="btn btn-danger" style="width:auto; padding:5px 10px;" onclick="deletePatient('${p.id}')">Sil</button>
                </div>`).join('') : "<div style='padding:10px; color:#999;'>Yok</div>";
        }

        // MODAL & CRUD
        window.openAddModal = function(d, t) {
            document.getElementById("patient-form").reset();
            document.getElementById("p-id").value = "";
            document.getElementById("btn-delete").classList.add("hidden");
            document.getElementById("p-doctor").value = currentDoctor;
            
            if(d) document.getElementById("p-date").value = d;
            if(t) {
                document.getElementById("p-time").value = t;
                document.getElementById("p-end-time").value = timeFromMinutes(minutesFromTime(t) + 30);
            }
            document.getElementById("patient-modal").style.display = "flex";
        }

        window.openEdit = function(id) {
            const p = patients.find(x => x.id == id);
            if(p) {
                document.getElementById("p-id").value = p.id;
                document.getElementById("p-name").value = p.name;
                document.getElementById("p-surname").value = p.surname;
                document.getElementById("p-tc").value = p.tc || "";
                document.getElementById("p-date").value = p.date;
                document.getElementById("p-time").value = p.time;
                document.getElementById("p-end-time").value = p.endTime || "";
                document.getElementById("p-doctor").value = p.doctor;
                document.getElementById("p-status").value = p.status;
                document.getElementById("p-price").value = p.price || "";
                document.getElementById("p-notes").value = p.notes || "";
                
                toggleFin(p.status);
                document.getElementById("btn-delete").classList.remove("hidden");
                document.getElementById("patient-modal").style.display = "flex";
            }
        }

        window.closeModal = function(id) { document.getElementById(id).style.display = "none"; }
        window.toggleFin = function(v) { document.getElementById("fin-box").classList.toggle("hidden", v !== 'bitti'); }

        window.savePatient = async function() {
            const id = document.getElementById("p-id").value;
            const newP = {
                name: document.getElementById("p-name").value,
                surname: document.getElementById("p-surname").value,
                tc: document.getElementById("p-tc").value,
                date: document.getElementById("p-date").value,
                time: document.getElementById("p-time").value,
                endTime: document.getElementById("p-end-time").value,
                doctor: document.getElementById("p-doctor").value,
                status: document.getElementById("p-status").value,
                price: Number(document.getElementById("p-price").value),
                notes: document.getElementById("p-notes").value
            };
            
            if(id) await updateDoc(doc(db, "patients", id), newP);
            else await addDoc(collection(db, "patients"), newP);
            closeModal('patient-modal');
        }

        window.deleteCurrentP = async function() {
            const id = document.getElementById("p-id").value;
            if(id) await deletePatient(id);
            closeModal('patient-modal');
        }

        window.deletePatient = async function(id) {
            if(confirm("Silmek istediğine emin misin?")) await deleteDoc(doc(db, "patients", id));
        }

        window.searchPatientByTC = function(val) {
            const p = patients.find(x => x.tc === val);
            if(p) {
                document.getElementById("p-name").value = p.name;
                document.getElementById("p-surname").value = p.surname;
            }
        }
    </script>
</body>
</html>
